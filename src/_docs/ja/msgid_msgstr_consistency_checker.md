# msgid_msgstr_consistency_checker.py

## 概要

`msgid_msgstr_consistency_checker.py` は、POファイル内の `msgid` と `msgstr` 間の整合性をチェックするスクリプトです。具体的には、エスケープシーケンスとHTMLタグが両者間で一致しているかを検証し、翻訳の品質を保証します。

## 主な機能

### 1. エスケープシーケンスのチェック
- `msgid` に含まれるエスケープシーケンス（`\n`、`\t`、`\\` など）が `msgstr` にも同じ数だけ含まれているかを検証
- 不足または余分なエスケープシーケンスを検出

### 2. HTMLタグのチェック
- `msgid` に含まれるHTMLタグ（`<b>`、`</i>` など）が `msgstr` でも同様に使用されているかを検証
- タグの種類と数の一致を確認

### 3. 自動修正機能
- 問題が検出されたエントリに自動的に `fuzzy` フラグを追加
- 翻訳者コメントに詳細なエラー情報を追加（`[Checker]` プレフィックス付き）

### 4. 固定フラグのサポート
- `fixed` フラグ（大文字小文字不問）が付いたエントリはチェックをスキップ

### 5. エラーエクスポート機能
- 問題のあるエントリのみを別のPOファイルに出力可能

### 6. 多言語サポート
- 出力メッセージは英語（en）、日本語（ja）、中国語（zh）に対応

## 使用方法

### 基本的な実行方法

```bash
# POファイルを指定して実行（日本語メッセージ）
python msgid_msgstr_consistency_checker.py path/to/your_file.po --language ja

# ファイル選択ダイアログを使用
python msgid_msgstr_consistency_checker.py

# 英語メッセージで実行
python msgid_msgstr_consistency_checker.py your_file.po --language en
```

### コマンドライン引数

| 引数 | 説明 | デフォルト値 |
|------|------|-------------|
| `po_file` | チェック対象のPOファイルパス（省略可） | なし（ダイアログ表示） |
| `-l`, `--language` | 出力メッセージの言語（en/ja/zh） | ja |
| `--no-export` | エラーエントリの別ファイル出力を無効化 | False（出力する） |

## 実行例

### 正常な場合

```bash
$ python msgid_msgstr_consistency_checker.py ja_JP.po
エラーなし。
```

### エラーが検出された場合

```bash
$ python msgid_msgstr_consistency_checker.py ja_JP.po
エントリ 123 に問題があります:
エスケープ文字に問題があります。
・不足しているエスケープ文字: '\n' が 2 個
・余分なエスケープ文字: '\t' が 1 個

エントリ 456 に問題があります:
HTMLタグに問題があります。
・不足しているHTMLタグ: 'b' が 1 個

エラーが検出されたため、'fuzzy' フラグとエラーの理由を PO ファイルに追加しました。
問題のあるエントリーを以下のファイルにエクスポートしました: ja_JP_errors.po
```

## エラーチェックの仕組み

### 1. エスケープシーケンスの検出
```python
# 以下のパターンを検出
\n  # 改行
\t  # タブ
\\  # バックスラッシュ
\r  # キャリッジリターン
# その他のエスケープシーケンス
```

### 2. HTMLタグの検出
```python
# 以下のようなタグを検出
<b>      # 太字開始タグ
</b>     # 太字終了タグ
<i>      # イタリック開始タグ
</i>     # イタリック終了タグ
# その他のHTMLタグ
```

### 3. 比較ロジック
- `Counter` を使用して各要素の出現回数をカウント
- `msgid` と `msgstr` の差分を計算
- 不足または余分な要素を特定

## 出力の解釈方法

### POファイルの更新内容

1. **fuzzyフラグの追加**
   ```po
   #, fuzzy
   msgid "Hello\nWorld"
   msgstr "こんにちは世界"
   ```

2. **翻訳者コメントの追加**
   ```po
   # [Checker] エスケープ文字に問題があります。
   # [Checker] ・不足しているエスケープ文字: '\n' が 1 個
   #, fuzzy
   msgid "Hello\nWorld"
   msgstr "こんにちは世界"
   ```

### エラーエクスポートファイル

問題のあるエントリのみを含む `*_errors.po` ファイルが生成されます：
- 元のファイル名に `_errors` を付加
- エラー情報を含む翻訳者コメント付き
- レビューや修正作業に活用可能

## トラブルシューティング

### ファイルが見つからないエラー
```
指定されたファイルが見つかりません: path/to/file.po
```
→ ファイルパスが正しいか確認してください

### 保存エラー
```
POファイルの保存中にエラーが発生しました。
```
→ ファイルの書き込み権限を確認してください

### 特定のエントリをチェックから除外したい場合
POファイルのエントリに `fixed` フラグを追加：
```po
#, fixed
msgid "Special case"
msgstr "特殊なケース"
```

## 注意事項

- スクリプトは元のPOファイルを直接更新します。実行前にバックアップを取ることを推奨します
- 空の `msgstr` はチェック対象外です
- HTML エンティティ（`&lt;`、`&gt;` など）は自動的にデコードされて処理されます
- チェック実行後は、fuzzyフラグが付いたエントリを手動で確認・修正する必要があります